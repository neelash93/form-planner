
/*
	an iteration on this bl.ock
	http://bl.ocks.org/ZJONSSON/2975320
	barStack - stacking with negative values
	[[{"y":30,"label":"Red","color":"pink","id":"2016-06"},{"y":30,"label":"Red","color":"pink","id":"2016-07"},{"y":30,"label":"Red","color":"pink","id":"2016-08"},{"y":30,"label":"Red","color":"pink","id":"2016-09"},{"y":30,"label":"Red","color":"pink","id":"2016-10"},{"y":30,"label":"Red","color":"pink","id":"2016-11"},{"y":30,"label":"Red","color":"pink","id":"2016-12"},{"y":30,"label":"Red","color":"pink","id":"2017-01"},{"y":30,"label":"Red","color":"pink","id":"2017-02"},{"y":30,"label":"Red","color":"pink","id":"2017-03"},{"y":30,"label":"Red","color":"pink","id":"2017-04"},{"y":30,"label":"Red","color":"pink","id":"2017-05"},{"y":30,"label":"Red","color":"pink","id":"2017-06"},{"y":30,"label":"Red","color":"pink","id":"2017-07"},{"y":30,"label":"Red","color":"pink","id":"2017-08"},{"y":30,"label":"Red","color":"pink","id":"2017-09"},{"y":30,"label":"Red","color":"pink","id":"2017-10"},{"y":30,"label":"Red","color":"pink","id":"2017-11"},{"y":30,"label":"Red","color":"pink","id":"2017-12"},{"y":30,"label":"Red","color":"pink","id":"2018-01"},{"y":30,"label":"Red","color":"pink","id":"2018-02"},{"y":30,"label":"Red","color":"pink","id":"2018-03"},{"y":30,"label":"Red","color":"pink","id":"2018-04"},{"y":30,"label":"Red","color":"pink","id":"2018-05"},{"y":30,"label":"Red","color":"pink","id":"2018-06"},{"y":30,"label":"Red","color":"pink","id":"2018-07"},{"y":30,"label":"Red","color":"pink","id":"2018-08"},{"y":30,"label":"Red","color":"pink","id":"2018-09"},{"y":30,"label":"Red","color":"pink","id":"2018-10"},{"y":30,"label":"Red","color":"pink","id":"2018-11"},{"y":30,"label":"Red","color":"pink","id":"2018-12"},{"y":30,"label":"Red","color":"pink","id":"2019-01"},{"y":30,"label":"Red","color":"pink","id":"2019-02"},{"y":30,"label":"Red","color":"pink","id":"2019-03"},{"y":30,"label":"Red","color":"pink","id":"2019-04"},{"y":30,"label":"Red","color":"pink","id":"2019-05"},{"y":30,"label":"Red","color":"pink","id":"2019-06"},{"y":30,"label":"Red","color":"pink","id":"2019-07"},{"y":30,"label":"Red","color":"pink","id":"2019-08"},{"y":30,"label":"Red","color":"pink","id":"2019-09"},{"y":30,"label":"Red","color":"pink","id":"2019-10"},{"y":30,"label":"Red","color":"pink","id":"2019-11"},{"y":30,"label":"Red","color":"pink","id":"2019-12"},{"y":30,"label":"Red","color":"pink","id":"2020-01"},{"y":30,"label":"Red","color":"pink","id":"2020-02"},{"y":30,"label":"Red","color":"pink","id":"2020-03"},{"y":30,"label":"Red","color":"pink","id":"2020-04"},{"y":30,"label":"Red","color":"pink","id":"2020-05"},{"y":30,"label":"Red","color":"pink","id":"2020-06"},{"y":30,"label":"Red","color":"pink","id":"2020-07"},{"y":30,"label":"Red","color":"pink","id":"2020-08"},{"y":30,"label":"Red","color":"pink","id":"2020-09"},{"y":30,"label":"Red","color":"pink","id":"2020-10"},{"y":30,"label":"Red","color":"pink","id":"2020-11"},{"y":30,"label":"Red","color":"pink","id":"2020-12"},{"y":30,"label":"Red","color":"pink","id":"2021-01"},{"y":30,"label":"Red","color":"pink","id":"2021-02"},{"y":30,"label":"Red","color":"pink","id":"2021-03"},{"y":30,"label":"Red","color":"pink","id":"2021-04"},{"y":30,"label":"Red","color":"pink","id":"2021-05"},{"y":30,"label":"Red","color":"pink","id":"2021-06"},{"y":30,"label":"Red","color":"pink","id":"2021-07"},{"y":30,"label":"Red","color":"pink","id":"2021-08"},{"y":30,"label":"Red","color":"pink","id":"2021-09"},{"y":30,"label":"Red","color":"pink","id":"2021-10"},{"y":30,"label":"Red","color":"pink","id":"2021-11"},{"y":30,"label":"Red","color":"pink","id":"2021-12"}],[{"y":30,"label":"Blue","color":"lightblue","id":"2016-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2016-12"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-01"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-02"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-03"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-04"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-05"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2017-12"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-01"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-02"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-03"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-04"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-05"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2018-12"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-01"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-02"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-03"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-04"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-05"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2019-12"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-01"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-02"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-03"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-04"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-05"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2020-12"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-01"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-02"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-03"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-04"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-05"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-06"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-07"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-08"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-09"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-10"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-11"},{"y":30,"label":"Blue","color":"lightblue","id":"2021-12"}],[{"y":30,"label":"White","color":"lightgray","id":"2016-06"},{"y":30,"label":"White","color":"lightgray","id":"2016-07"},{"y":30,"label":"White","color":"lightgray","id":"2016-08"},{"y":30,"label":"White","color":"lightgray","id":"2016-09"},{"y":30,"label":"White","color":"lightgray","id":"2016-10"},{"y":30,"label":"White","color":"lightgray","id":"2016-11"},{"y":30,"label":"White","color":"lightgray","id":"2016-12"},{"y":30,"label":"White","color":"lightgray","id":"2017-01"},{"y":30,"label":"White","color":"lightgray","id":"2017-02"},{"y":30,"label":"White","color":"lightgray","id":"2017-03"},{"y":30,"label":"White","color":"lightgray","id":"2017-04"},{"y":30,"label":"White","color":"lightgray","id":"2017-05"},{"y":30,"label":"White","color":"lightgray","id":"2017-06"},{"y":30,"label":"White","color":"lightgray","id":"2017-07"},{"y":30,"label":"White","color":"lightgray","id":"2017-08"},{"y":30,"label":"White","color":"lightgray","id":"2017-09"},{"y":30,"label":"White","color":"lightgray","id":"2017-10"},{"y":30,"label":"White","color":"lightgray","id":"2017-11"},{"y":30,"label":"White","color":"lightgray","id":"2017-12"},{"y":30,"label":"White","color":"lightgray","id":"2018-01"},{"y":30,"label":"White","color":"lightgray","id":"2018-02"},{"y":30,"label":"White","color":"lightgray","id":"2018-03"},{"y":30,"label":"White","color":"lightgray","id":"2018-04"},{"y":30,"label":"White","color":"lightgray","id":"2018-05"},{"y":30,"label":"White","color":"lightgray","id":"2018-06"},{"y":30,"label":"White","color":"lightgray","id":"2018-07"},{"y":30,"label":"White","color":"lightgray","id":"2018-08"},{"y":30,"label":"White","color":"lightgray","id":"2018-09"},{"y":30,"label":"White","color":"lightgray","id":"2018-10"},{"y":30,"label":"White","color":"lightgray","id":"2018-11"},{"y":30,"label":"White","color":"lightgray","id":"2018-12"},{"y":30,"label":"White","color":"lightgray","id":"2019-01"},{"y":30,"label":"White","color":"lightgray","id":"2019-02"},{"y":30,"label":"White","color":"lightgray","id":"2019-03"},{"y":30,"label":"White","color":"lightgray","id":"2019-04"},{"y":30,"label":"White","color":"lightgray","id":"2019-05"},{"y":30,"label":"White","color":"lightgray","id":"2019-06"},{"y":30,"label":"White","color":"lightgray","id":"2019-07"},{"y":30,"label":"White","color":"lightgray","id":"2019-08"},{"y":30,"label":"White","color":"lightgray","id":"2019-09"},{"y":30,"label":"White","color":"lightgray","id":"2019-10"},{"y":30,"label":"White","color":"lightgray","id":"2019-11"},{"y":30,"label":"White","color":"lightgray","id":"2019-12"},{"y":30,"label":"White","color":"lightgray","id":"2020-01"},{"y":30,"label":"White","color":"lightgray","id":"2020-02"},{"y":30,"label":"White","color":"lightgray","id":"2020-03"},{"y":30,"label":"White","color":"lightgray","id":"2020-04"},{"y":30,"label":"White","color":"lightgray","id":"2020-05"},{"y":30,"label":"White","color":"lightgray","id":"2020-06"},{"y":30,"label":"White","color":"lightgray","id":"2020-07"},{"y":30,"label":"White","color":"lightgray","id":"2020-08"},{"y":30,"label":"White","color":"lightgray","id":"2020-09"},{"y":30,"label":"White","color":"lightgray","id":"2020-10"},{"y":30,"label":"White","color":"lightgray","id":"2020-11"},{"y":30,"label":"White","color":"lightgray","id":"2020-12"},{"y":30,"label":"White","color":"lightgray","id":"2021-01"},{"y":30,"label":"White","color":"lightgray","id":"2021-02"},{"y":30,"label":"White","color":"lightgray","id":"2021-03"},{"y":30,"label":"White","color":"lightgray","id":"2021-04"},{"y":30,"label":"White","color":"lightgray","id":"2021-05"},{"y":30,"label":"White","color":"lightgray","id":"2021-06"},{"y":30,"label":"White","color":"lightgray","id":"2021-07"},{"y":30,"label":"White","color":"lightgray","id":"2021-08"},{"y":30,"label":"White","color":"lightgray","id":"2021-09"},{"y":30,"label":"White","color":"lightgray","id":"2021-10"},{"y":30,"label":"White","color":"lightgray","id":"2021-11"},{"y":30,"label":"White","color":"lightgray","id":"2021-12"}]]

*/

function barStack(seriesData) {
	var l = seriesData[0].length
	while (l--) {
		var posBase = 0; // positive base
		var negBase = 0; // negative base

		seriesData.forEach(function(d) {
			d = d[l]
			d.size = Math.abs(d.y)
			if (d.y < 0) {
				d.y0 = negBase
				negBase -= d.size
			} else
			{
				d.y0 = posBase = posBase + d.size
			}
		})
	}
	seriesData.extent = d3.extent(
		d3.merge(
			d3.merge(
				seriesData.map(function(e) {
					return e.map(function(f) { return [f.y0,f.y0-f.size] })
				})
			)
		)
	)
}

/* Here is an example */

// each series is an array of objects
// our data is in turn an array of those series arrays
// which is to say
// an array of arrays of objects
// var app = angular.module('graphApp', []).
// controller('graphCtrl', function($scope) {


	var data;
	var dates;

	d3.json("/ajax/graphdata.json", function(error, json) {
	  if (error) return console.warn(error);
	  data = json;
		// data=datafile;

	d3.json("/ajax/dates.json", function(error1, json1) {
	    if (error1) return console.warn(error1);
	    dates = json1;
			// dates = datesfile;

	var h = 500;
	var w = 3500;
	var margin = 20;
	var color = d3.scale.category10();

	var x = d3.scale.ordinal()
		.domain(dates)
		.rangeRoundBands([ margin, w - margin ], .1)

	var y = d3.scale.linear()
		.range([h-margin,0+margin]);

	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom")
		.tickSize(6, 0);

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left");

	barStack(data);
	y.domain(data.extent);

	svg = d3.select("#usage")
		.append("svg")
		.attr("height", h)
		.attr("width", w)

	svg.selectAll(".series")
		.data(data)
		.enter()
		.append("g")
		.classed("series", true)
		.style("fill", function(d,i) { return d[i].color })
		.style("opacity", 0.8)
			.selectAll("rect")
			.data(Object)
			.enter()
			.append("rect")
				.attr("x", function(d, i) { return x(x.domain()[i]) })
				.attr("y", function(d) { return y(d.y0) })
				.attr("height", function(d) { return y(0) - y(d.size) })
				.attr("width", x.rangeBand())
				.on("mouseover", function() { tooltipz.style("display", null); })
	  		.on("mouseout", function() { tooltipz.style("display", "none"); })
	  		.on("mousemove", function(d) {
	    		var xPosition = d3.mouse(this)[0] - 55;
	    		var yPosition = d3.mouse(this)[1] - 5;
	    		tooltipz.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
	    		tooltipz.select("text").text(d.y + ' : ' + d.label);
	  		});

	//console.log("y(0)", y(0));
	//console.log("margin", margin);

	svg.append("g")
		.attr("class", "axis x")
		.attr("transform", "translate(0 " + y(0) + ")")
		.call(xAxis);

	svg.append("g")
		.attr("class", "axis y")
		.attr("transform", "translate(" + margin + " 0)")
		.call(yAxis);

	/* Here we add tooltips */

	// Prep the tooltip bits, initial display is hidden
	var tooltipz = svg.append("g")
	  .attr("class", "tooltipz")
	  .style("display", "none");

	tooltipz.append("rect")
	  .attr("width", 0)
	  .attr("height", 20)
	  .attr("fill", "white")
	  .style("opacity", 0.5);

	tooltipz.append("text")
	  .attr("x", 15)
	  .attr("dy", "1.2em")
	  .style("text-anchor", "middle")
	  .attr("font-size", "12px")
	  .attr("font-weight", "bold");

	})});
// });
	(function ($) {
	  $('.spinner .btn:first-of-type').on('click', function() {
	    $('.spinner input').val( parseInt($('.spinner input').val(), 10) + 1);
	  });
	  $('.spinner .btn:last-of-type').on('click', function() {
	    $('.spinner input').val( parseInt($('.spinner input').val(), 10) - 1);
	  });
	})(jQuery);
